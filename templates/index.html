{% extends "base.html" %}

{% block content %}
  <section class="hero">
    <h1>{{ t("upload_title") }}</h1>
    <p class="muted">{{ t("upload_hint") }}</p>

    <div class="card upload-card">
      <form id="uploadForm">
        <input type="file" name="file" id="fileInput" accept="image/*" required />
        <button class="btn" type="submit">{{ t("upload_button") }}</button>
        <div class="muted small">
          {{ t("supported_formats") }}: {{ ", ".join(config.ALLOWED_EXTENSIONS|list|sort) }}
          Â· {{ t("max_size") }}: 16MB
        </div>
      </form>

      <div id="uploadResult" class="result hidden">
        <div class="result-grid">
          <div>
            <img id="previewImg" class="preview" alt="preview"/>
          </div>
          <div>
            <h3>{{ t("model_result") }}</h3>
            <pre id="descText"></pre>
          </div>
        </div>
      </div>

      <div id="uploadError" class="error hidden"></div>
    </div>
  </section>

  <section class="section">
    <h2>{{ t("category_title") }}</h2>

    <div class="grid">
      {% for cid, cinfo in categories.items() %}
        <a class="card category-card"
           href="{{ url_for('category', category_id=cid, lang=current_lang()) }}">
          <div class="icon">
            <i class="fa-solid {{ cinfo.icon }}"></i>
          </div>
          <div class="content">
            <h3>{{ cinfo.name|l10n }}</h3>
            <p class="muted">{{ cinfo.description|l10n }}</p>
            <div class="small muted">{{ cinfo.count }}+ species</div>
          </div>
        </a>
      {% endfor %}
    </div>
  </section>
{% endblock %}

{% block scripts %}
<script>
  const form = document.getElementById("uploadForm");
  const fileInput = document.getElementById("fileInput");
  const resultBox = document.getElementById("uploadResult");
  const errorBox = document.getElementById("uploadError");
  const previewImg = document.getElementById("previewImg");
  const descText = document.getElementById("descText");

  function show(el) { el.classList.remove("hidden"); }
  function hide(el) { el.classList.add("hidden"); }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    hide(resultBox);
    hide(errorBox);

    const file = fileInput.files[0];
    if (!file) return;

    const fd = new FormData();
    fd.append("file", file);

    try {
      const res = await fetch("{{ url_for('upload') }}?lang={{ current_lang() }}", {
        method: "POST",
        body: fd
      });
      const data = await res.json();
      if (!data.success) {
        errorBox.textContent = data.error || "Error";
        show(errorBox);
        return;
      }

      previewImg.src = data.image_url;
      descText.textContent = data.description || "";
      show(resultBox);

    } catch (err) {
      errorBox.textContent = String(err);
      show(errorBox);
    }
  });
</script>
{% endblock %}
